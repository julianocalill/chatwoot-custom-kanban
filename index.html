<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM BeMore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .ghost-card { background: #eff6ff; border: 2px dashed #3b82f6; opacity: 0.5; }
        .deal-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm text-gray-700">

    <div class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-xl text-gray-800 tracking-tight">üöÄ BeMore CRM</h1>
            <div id="total-pipeline" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold border border-green-200">
                Pipeline: R$ 0,00
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="app.exportCSV()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 transition">
                üì• Exportar
            </button>
            <button onclick="ui.openModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium shadow-sm transition">
                + Novo Neg√≥cio
            </button>
            <button onclick="ui.toggleSettings()" class="p-2 text-gray-400 hover:text-gray-600">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="board" class="flex-1 overflow-x-auto overflow-y-hidden flex p-6 gap-6 items-start">
        </div>

    <div id="dealModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" id="modalTitle">Novo Neg√≥cio</h2>
                <button onclick="ui.closeModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            
            <form id="dealForm" onsubmit="app.saveDeal(event)">
                <input type="hidden" id="dealId">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">T√≠tulo do Neg√≥cio / Cliente</label>
                        <input type="text" id="dealTitle" required class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Contrato Empresa X">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Valor (R$)</label>
                            <input type="number" id="dealValue" step="0.01" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Prioridade</label>
                            <select id="dealPriority" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white">
                                <option value="low">üü¢ Baixa</option>
                                <option value="medium" selected>üü° M√©dia</option>
                                <option value="high">üî¥ Alta</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">ID da Conversa (Chatwoot)</label>
                        <div class="flex gap-2">
                            <input type="text" id="dealChatId" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Opcional: ID num√©rico">
                            <button type="button" onclick="app.fetchChatInfo()" class="px-3 bg-gray-100 border rounded-lg hover:bg-gray-200" title="Testar ID">üîç</button>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">Se preenchido, abre o chat ao clicar no card.</p>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Notas</label>
                        <textarea id="dealNotes" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" onclick="app.archiveDeal()" id="btnArchive" class="hidden px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium">Arquivar (Perdido/Ganho)</button>
                    <button type="button" onclick="ui.closeModal()" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transform active:scale-95 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-96 p-6">
            <h2 class="font-bold text-lg mb-4">Configura√ß√£o do Sistema</h2>
            <div class="space-y-3">
                <input type="text" id="sbUrl" placeholder="Supabase URL (https://...)" class="w-full border p-2 rounded text-xs">
                <input type="password" id="sbKey" placeholder="Supabase Anon Key" class="w-full border p-2 rounded text-xs">
                <hr>
                <input type="text" id="cwUrl" placeholder="Chatwoot URL" class="w-full border p-2 rounded text-xs">
            </div>
            <button onclick="app.saveSettings()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded font-bold">Salvar Conex√£o</button>
        </div>
    </div>

    <script>
        // --- BLINDAGEM DO SISTEMA ---
        // Garante que o app seja global para os bot√µes funcionarem
        window.app = {};
        window.ui = {};
        
        // Configura√ß√£o inicial segura
        const config = {
            stages: {
                'prospeccao': { title: 'üîé Prospec√ß√£o', color: 'border-blue-500' },
                'qualificacao': { title: 'üí¨ Qualifica√ß√£o', color: 'border-yellow-500' },
                'proposta': { title: 'üìÑ Proposta Enviada', color: 'border-orange-500' },
                'negociacao': { title: 'ü§ù Negocia√ß√£o', color: 'border-purple-500' },
                'fechamento': { title: 'üí∞ Fechamento', color: 'border-green-500' }
            },
            sbUrl: localStorage.getItem('crm_sb_url') || '',
            sbKey: localStorage.getItem('crm_sb_key') || '',
            cwUrl: localStorage.getItem('crm_cw_url') || 'https://chat.bemore.ia.br'
        };

        let supabase = null;

        // --- L√ìGICA DO APP ---
        window.app = {
            init: async () => {
                console.log("üöÄ Iniciando BeMore CRM...");
                
                // Verifica se a biblioteca Supabase carregou
                if (typeof window.supabase === 'undefined') {
                    console.error("‚ùå Erro Cr√≠tico: A biblioteca do Supabase n√£o carregou.");
                    alert("Erro de conex√£o: O sistema de banco de dados n√£o p√¥de ser carregado. Verifique sua internet ou bloqueadores de an√∫ncio.");
                    return;
                }

                // Verifica credenciais
                if (!config.sbUrl || !config.sbKey) {
                    console.warn("‚ö†Ô∏è Sem credenciais. Abrindo configura√ß√µes...");
                    window.ui.toggleSettings();
                    return;
                }

                try {
                    // Inicializa Supabase
                    const { createClient } = window.supabase;
                    supabase = createClient(config.sbUrl, config.sbKey);
                    console.log("‚úÖ Conex√£o com Supabase iniciada.");
                    
                    // Desenha colunas e carrega dados
                    window.ui.renderBoard();
                    await window.app.loadDeals();
                } catch (e) {
                    console.error("Erro na inicializa√ß√£o:", e);
                    alert("Erro ao iniciar sistema: " + e.message);
                }
            },

            loadDeals: async () => {
                if(!supabase) return;
                console.log("üì• Buscando neg√≥cios...");
                
                const { data, error } = await supabase
                    .from('deals')
                    .select('*')
                    .neq('status', 'archived')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Erro Supabase:", error);
                    // Se o erro for 401/400, as chaves podem estar erradas
                    if(error.code === 'PGRST301' || error.message.includes('JWT')) {
                        alert("Suas credenciais do Supabase parecem inv√°lidas. Verifique a URL e a Key nas configura√ß√µes.");
                        window.ui.toggleSettings();
                    }
                    return;
                }

                // Limpa listas
                document.querySelectorAll('.kanban-list').forEach(el => el.innerHTML = '');
                
                let total = 0;

                data.forEach(deal => {
                    const col = document.getElementById(`col-${deal.stage}`);
                    if (col) {
                        col.appendChild(window.ui.createCard(deal));
                        total += parseFloat(deal.value || 0);
                    }
                });

                document.getElementById('total-pipeline').innerText = `Pipeline: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total)}`;
                window.ui.updateCounts();
            },

            saveDeal: async (e) => {
                e.preventDefault();
                if(!supabase) return;

                const id = document.getElementById('dealId').value;
                const deal = {
                    title: document.getElementById('dealTitle').value,
                    value: document.getElementById('dealValue').value || 0,
                    priority: document.getElementById('dealPriority').value,
                    chatwoot_id: document.getElementById('dealChatId').value,
                    notes: document.getElementById('dealNotes').value,
                };

                let error;
                if (id) {
                    const res = await supabase.from('deals').update(deal).eq('id', id);
                    error = res.error;
                } else {
                    const res = await supabase.from('deals').insert([{ ...deal, stage: 'prospeccao' }]);
                    error = res.error;
                }

                if (error) alert('Erro ao salvar: ' + error.message);
                else {
                    window.ui.closeModal();
                    window.app.loadDeals();
                }
            },

            moveDeal: async (id, newStage) => {
                if(!supabase) return;
                await supabase.from('deals').update({ stage: newStage }).eq('id', id);
                window.app.loadDeals();
            },

            saveSettings: () => {
                const url = document.getElementById('sbUrl').value.trim();
                const key = document.getElementById('sbKey').value.trim();
                
                if(!url || !key) {
                    alert("Por favor, preencha a URL e a Key do Supabase.");
                    return;
                }

                localStorage.setItem('crm_sb_url', url);
                localStorage.setItem('crm_sb_key', key);
                localStorage.setItem('crm_cw_url', document.getElementById('cwUrl').value);
                
                alert("Configura√ß√µes salvas! A p√°gina ser√° recarregada.");
                location.reload();
            },

            exportCSV: async () => {
                if(!supabase) return;
                const { data } = await supabase.from('deals').select('*');
                if(!data || data.length === 0) {
                    alert("Nenhum dado para exportar.");
                    return;
                }
                
                let csv = 'ID,Data,Titulo,Valor,Etapa,Status,Chatwoot ID,Notas\n';
                data.forEach(row => {
                    // Trata aspas e quebras de linha nas notas para n√£o quebrar o CSV
                    const safeNotes = (row.notes || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    const safeTitle = (row.title || '').replace(/"/g, '""');
                    
                    csv += `${row.id},${row.created_at},"${safeTitle}",${row.value},${row.stage},${row.status},${row.chatwoot_id || ''},"${safeNotes}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `crm_export_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },
            
            archiveDeal: async () => {
                const id = document.getElementById('dealId').value;
                if(!id || !supabase) return;
                const status = confirm("Marcar como GANHO? (OK = Ganho, Cancelar = Perdido)") ? 'won' : 'lost';
                
                await supabase.from('deals').update({ status: 'archived', notes: `[${status.toUpperCase()}] ` + document.getElementById('dealNotes').value }).eq('id', id);
                window.ui.closeModal();
                window.app.loadDeals();
            },
            
            fetchChatInfo: async () => {
                const id = document.getElementById('dealChatId').value;
                if(!id) return;
                window.open(`${config.cwUrl}/app/accounts/1/conversations/${id}`, '_blank');
            }
        };

        // --- L√ìGICA VISUAL (UI) ---
        window.ui = {
            renderBoard: () => {
                const board = document.getElementById('board');
                board.innerHTML = '';
                Object.entries(config.stages).forEach(([key, info]) => {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col w-[320px] min-w-[320px] max-h-full';
                    col.innerHTML = `
                        <div class="flex justify-between items-center mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full ${info.color.replace('border', 'bg')}"></span>
                                <h3 class="font-bold text-gray-700 uppercase text-xs tracking-wider">${info.title}</h3>
                            </div>
                            <span class="count bg-white px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-500 shadow-sm border">0</span>
                        </div>
                        <div class="kanban-list flex-1 bg-gray-100/50 rounded-xl p-2 space-y-3 overflow-y-auto border border-gray-200/60 custom-scrollbar" id="col-${key}" data-stage="${key}"></div>
                    `;
                    board.appendChild(col);

                    // Inicializa Drag & Drop com seguran√ßa
                    if(typeof Sortable !== 'undefined') {
                        new Sortable(col.querySelector('.kanban-list'), {
                            group: 'deals',
                            animation: 150,
                            ghostClass: 'ghost-card',
                            onEnd: (evt) => {
                                const item = evt.item;
                                const newStage = evt.to.dataset.stage;
                                const oldStage = evt.from.dataset.stage;
                                if (newStage !== oldStage) {
                                    window.app.moveDeal(item.dataset.id, newStage);
                                }
                            }
                        });
                    }
                });
            },

            createCard: (deal) => {
                const el = document.createElement('div');
                el.className = 'deal-card bg-white p-4 rounded-lg shadow-sm border border-gray-100 cursor-pointer transition-all relative group';
                el.dataset.id = deal.id;
                el.onclick = (e) => {
                    if(!e.target.closest('.action-btn')) window.ui.editDeal(deal);
                };

                const formattedValue = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(deal.value);
                const date = new Date(deal.created_at).toLocaleDateString('pt-BR');
                
                const chatLink = deal.chatwoot_id 
                    ? `<a href="${config.cwUrl}/app/accounts/1/conversations/${deal.chatwoot_id}" target="_blank" class="action-btn text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1">üí¨ Chat #${deal.chatwoot_id}</a>` 
                    : '';

                const prioColors = { low: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', high: 'bg-red-100 text-red-700' };
                
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] ${prioColors[deal.priority]} px-1.5 py-0.5 rounded font-bold uppercase tracking-wide">${deal.priority}</span>
                        <span class="text-[10px] text-gray-400">${date}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2">${deal.title}</h4>
                    <p class="font-mono text-xs text-gray-600 font-medium mb-3">${formattedValue}</p>
                    
                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        ${chatLink}
                        <span class="text-[10px] text-gray-400">ID: ${deal.id}</span>
                    </div>
                `;
                return el;
            },

            editDeal: (deal) => {
                document.getElementById('dealId').value = deal.id;
                document.getElementById('dealTitle').value = deal.title;
                document.getElementById('dealValue').value = deal.value;
                document.getElementById('dealPriority').value = deal.priority;
                document.getElementById('dealChatId').value = deal.chatwoot_id || '';
                document.getElementById('dealNotes').value = deal.notes || '';
                document.getElementById('modalTitle').innerText = 'Editar Neg√≥cio';
                document.getElementById('btnArchive').classList.remove('hidden');
                
                document.getElementById('dealModal').classList.remove('hidden');
            },

            openModal: () => {
                document.getElementById('dealForm').reset();
                document.getElementById('dealId').value = '';
                document.getElementById('modalTitle').innerText = 'Novo Neg√≥cio';
                document.getElementById('btnArchive').classList.add('hidden');
                document.getElementById('dealModal').classList.remove('hidden');
            },

            closeModal: () => document.getElementById('dealModal').classList.add('hidden'),

            toggleSettings: () => {
                const m = document.getElementById('settingsModal');
                m.classList.toggle('hidden');
                if(!m.classList.contains('hidden')){
                    document.getElementById('sbUrl').value = config.sbUrl || '';
                    document.getElementById('sbKey').value = config.sbKey || '';
                    document.getElementById('cwUrl').value = config.cwUrl;
                }
            },
            
            updateCounts: () => {
                document.querySelectorAll('.kanban-list').forEach(list => {
                    list.previousElementSibling.querySelector('.count').innerText = list.children.length;
                });
            }
        };

        // Inicializa√ß√£o Segura
        document.addEventListener('DOMContentLoaded', window.app.init);

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM BeMore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .ghost-card { background: #eff6ff; border: 2px dashed #3b82f6; opacity: 0.5; }
        .deal-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        /* Badge do Canal */
        .channel-icon.whatsapp { color: #25D366; background: #dcf8c6; }
        .channel-icon.web_widget { color: #3b82f6; background: #dbeafe; }
        .channel-icon.api { color: #8b5cf6; background: #ede9fe; }
        .channel-icon.email { color: #ea580c; background: #ffedd5; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm text-gray-700">

    <div class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-xl text-gray-800 tracking-tight flex items-center gap-2">
                <i class="fa-solid fa-rocket text-blue-600"></i> BeMore CRM
            </h1>
            <div id="total-pipeline" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold border border-green-200">
                R$ 0,00
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="window.app.exportCSV()" class="flex items-center gap-2 px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded text-gray-600 transition border">
                <i class="fa-solid fa-download"></i> Exportar
            </button>
            <button onclick="window.ui.openModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium shadow-sm transition">
                <i class="fa-solid fa-plus"></i> Novo Neg√≥cio
            </button>
            <button onclick="window.ui.toggleSettings()" class="p-2 text-gray-400 hover:text-gray-600 transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div id="board" class="flex-1 overflow-x-auto overflow-y-hidden flex p-6 gap-6 items-start bg-slate-50">
        <div class="m-auto text-gray-400 text-center animate-pulse">Carregando CRM...</div>
    </div>

    <div id="dealModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm overflow-y-auto py-10">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] p-6 transform transition-all scale-100 relative">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2" id="modalTitle">
                    <i class="fa-regular fa-id-card"></i> Novo Neg√≥cio
                </h2>
                <button onclick="window.ui.closeModal()" class="text-gray-400 hover:text-red-500 text-2xl transition">&times;</button>
            </div>
            
            <form id="dealForm" onsubmit="window.app.saveDeal(event)">
                <input type="hidden" id="dealId">
                <input type="hidden" id="conversationStart">
                
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100">
                    <label class="block text-xs font-bold uppercase text-blue-600 mb-2">üîÑ Vincular Chatwoot (Auto-preencher)</label>
                    <div class="flex gap-2">
                        <input type="text" id="dealPhone" class="flex-1 border border-blue-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Telefone (ex: +55...) ou ID da Conversa">
                        <button type="button" onclick="window.app.fetchChatwootData()" class="px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass"></i> Buscar
                        </button>
                    </div>
                    <p class="text-[10px] text-blue-400 mt-1 pl-1">Busca dados no Chatwoot. Se n√£o existir, criaremos o contato ao salvar.</p>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Cliente / T√≠tulo</label>
                            <input type="text" id="dealTitle" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-blue-500" placeholder="Nome do Cliente">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Empresa</label>
                            <input type="text" id="dealCompany" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-blue-500" placeholder="Empresa Ltda">
                        </div>
                    </div>

                    <div>
                         <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Email</label>
                         <input type="email" id="dealEmail" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-blue-500" placeholder="email@cliente.com">
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Valor (R$)</label>
                            <input type="number" id="dealValue" step="0.01" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-blue-500" placeholder="0.00">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Chat ID</label>
                            <input type="text" id="dealChatId" class="w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50" readonly placeholder="Auto">
                        </div>
                         <div class="col-span-1">
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Canal (Edit√°vel)</label>
                            <input type="text" id="dealChannel" class="w-full border border-gray-300 rounded-lg p-2.5 focus:border-blue-500 outline-none" placeholder="Ex: Indica√ß√£o">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">üìÖ Data Reuni√£o</label>
                            <input type="datetime-local" id="dealMeeting" class="w-full border border-gray-200 rounded-lg p-2 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">üèÅ Previs√£o Fechamento</label>
                            <input type="date" id="dealClosing" class="w-full border border-gray-200 rounded-lg p-2 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Notas / Detalhes</label>
                        <textarea id="dealNotes" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-blue-500"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-between items-center pt-4 border-t">
                     <button type="button" onclick="window.app.archiveDeal()" id="btnArchive" class="hidden text-red-500 hover:text-red-700 text-xs font-bold uppercase flex items-center gap-1">
                        <i class="fa-solid fa-trash"></i> Arquivar / Ganho / Perdido
                    </button>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" onclick="window.ui.closeModal()" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transform active:scale-95 transition">Salvar Neg√≥cio</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-96 p-6 shadow-2xl">
            <h2 class="font-bold text-lg mb-4 text-gray-800">üîå Conex√µes</h2>
            
            <div class="space-y-4">
                <div class="bg-yellow-50 p-3 rounded text-[10px] text-yellow-800 border border-yellow-200">
                    <i class="fa-solid fa-triangle-exclamation"></i> <b>Aten√ß√£o:</b> Essas configura√ß√µes ficam salvas neste navegador. Se usar outro computador, precisar√° preencher novamente.
                </div>

                <div>
                    <h3 class="text-xs font-bold text-blue-600 uppercase mb-2">Banco de Dados (Supabase)</h3>
                    <input type="text" id="sbUrl" placeholder="Project URL" class="w-full border p-2 rounded text-xs mb-2">
                    <input type="password" id="sbKey" placeholder="Anon Key" class="w-full border p-2 rounded text-xs">
                </div>
                <hr>
                <div>
                    <h3 class="text-xs font-bold text-green-600 uppercase mb-2">Chatwoot API</h3>
                    <input type="text" id="cwUrl" placeholder="URL (ex: https://chat.bemore.ia.br)" class="w-full border p-2 rounded text-xs mb-2">
                    <input type="text" id="cwToken" placeholder="User Access Token (Perfil)" class="w-full border p-2 rounded text-xs mb-2">
                    <input type="text" id="cwAccount" placeholder="ID da Conta (ex: 1)" class="w-full border p-2 rounded text-xs">
                </div>
            </div>
            <button onclick="window.app.saveSettings()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold transition">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <script>
        window.supabaseClient = null;
        
        const config = {
            stages: {
                'prospeccao': { title: 'üîé Prospec√ß√£o', color: 'border-blue-500' },
                'qualificacao': { title: 'üí¨ Qualifica√ß√£o', color: 'border-yellow-500' },
                'proposta': { title: 'üìÑ Proposta', color: 'border-orange-500' },
                'negociacao': { title: 'ü§ù Negocia√ß√£o', color: 'border-purple-500' },
                'fechamento': { title: 'üí∞ Fechamento', color: 'border-green-500' }
            },
            sbUrl: localStorage.getItem('crm_sb_url') || '',
            sbKey: localStorage.getItem('crm_sb_key') || '',
            cwUrl: localStorage.getItem('crm_cw_url') || '',
            cwToken: localStorage.getItem('crm_cw_token') || '',
            cwAccount: localStorage.getItem('crm_cw_account') || '1'
        };

        window.app = {
            init: async () => {
                if (typeof window.supabase === 'undefined') return alert("Erro: Lib Supabase off.");
                
                if (!config.sbUrl || !config.sbKey) {
                    window.ui.toggleSettings();
                    return;
                }

                try {
                    const { createClient } = window.supabase;
                    window.supabaseClient = createClient(config.sbUrl, config.sbKey);
                    window.ui.renderBoard();
                    await window.app.loadDeals();
                } catch (e) {
                    alert("Erro ao iniciar: " + e.message);
                }
            },

            loadDeals: async () => {
                if(!window.supabaseClient) return;
                const { data, error } = await window.supabaseClient.from('deals').select('*').neq('status', 'archived').order('created_at', { ascending: false });
                
                if (error) {
                    console.error(error);
                    if(error.code === '401') window.ui.toggleSettings();
                    return;
                }

                document.querySelectorAll('.kanban-list').forEach(el => el.innerHTML = '');
                let total = 0;
                
                if(data) {
                    data.forEach(deal => {
                        const col = document.getElementById(`col-${deal.stage}`);
                        if (col) {
                            col.appendChild(window.ui.createCard(deal));
                            total += parseFloat(deal.value || 0);
                        }
                    });
                }
                document.getElementById('total-pipeline').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
                window.ui.updateCounts();
            },

            fetchChatwootData: async () => {
                const query = document.getElementById('dealPhone').value.trim();
                if(!query) return alert("Digite um telefone ou ID para buscar.");
                if(!config.cwToken || !config.cwUrl) return alert("Configure o Token do Chatwoot na engrenagem.");

                const btn = document.querySelector('button[onclick="window.app.fetchChatwootData()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Buscando...';

                try {
                    // Busca Contato
                    let searchUrl = `${config.cwUrl}/api/v1/accounts/${config.cwAccount}/contacts/search?q=${query}`;
                    let res = await fetch(searchUrl, { headers: { 'api_access_token': config.cwToken } });
                    let json = await res.json();
                    
                    let contact = null;
                    if(json.payload && json.payload.length > 0) {
                        contact = json.payload[0];
                    } else {
                        // Busca Conversa ID
                        if(!isNaN(query)) {
                             let convRes = await fetch(`${config.cwUrl}/api/v1/accounts/${config.cwAccount}/conversations/${query}`, { headers: { 'api_access_token': config.cwToken } });
                             if(convRes.ok) {
                                 let convJson = await convRes.json();
                                 contact = convJson.meta.sender;
                                 document.getElementById('dealChatId').value = convJson.id;
                                 if(convJson.created_at) document.getElementById('conversationStart').value = new Date(convJson.created_at * 1000).toISOString();
                                 document.getElementById('dealChannel').value = convJson.meta.channel || 'api';
                             }
                        }
                    }

                    if(contact) {
                        document.getElementById('dealTitle').value = contact.name || 'Sem nome';
                        document.getElementById('dealEmail').value = contact.email || '';
                        document.getElementById('dealPhone').value = contact.phone_number || query;
                        
                        if(contact.additional_attributes?.company_name) document.getElementById('dealCompany').value = contact.additional_attributes.company_name;
                        else if (contact.company) document.getElementById('dealCompany').value = contact.company.name;

                        // Busca conversa se faltar
                        if(!document.getElementById('dealChatId').value) {
                             let convsRes = await fetch(`${config.cwUrl}/api/v1/accounts/${config.cwAccount}/contacts/${contact.id}/conversations`, { headers: { 'api_access_token': config.cwToken } });
                             let convsJson = await convsRes.json();
                             if(convsJson.payload && convsJson.payload.length > 0) {
                                 const lastConv = convsJson.payload[0];
                                 document.getElementById('dealChatId').value = lastConv.id;
                                 document.getElementById('dealChannel').value = lastConv.meta.channel;
                                 if(lastConv.created_at) document.getElementById('conversationStart').value = new Date(lastConv.created_at * 1000).toISOString();
                             }
                        }
                        
                        btn.className = "px-4 bg-green-600 text-white rounded-lg font-medium shadow-sm flex items-center gap-2";
                        btn.innerHTML = '<i class="fa-solid fa-check"></i> Encontrado!';
                        setTimeout(() => { btn.className = "px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-sm flex items-center gap-2"; btn.innerHTML = originalText; }, 2000);

                    } else {
                        alert("Nada encontrado. Preencha os dados e salvaremos um novo contato.");
                        btn.innerHTML = originalText;
                    }

                } catch (e) {
                    console.error(e);
                    alert("Erro na busca: " + e.message);
                    btn.innerHTML = originalText;
                }
            },

            // --- CRIA CONTATO NO CHATWOOT SE N√ÉO EXISTIR ---
            createChatwootContact: async (deal) => {
                if(!config.cwUrl || !config.cwToken) return;
                console.log("Tentando criar contato no Chatwoot...");
                
                try {
                    const body = {
                        name: deal.title,
                        email: deal.email,
                        phone_number: deal.phone,
                        company_name: deal.company
                    };
                    
                    const res = await fetch(`${config.cwUrl}/api/v1/accounts/${config.cwAccount}/contacts`, {
                        method: 'POST',
                        headers: { 
                            'api_access_token': config.cwToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if(res.ok) {
                        console.log("‚úÖ Contato criado no Chatwoot!");
                        const json = await res.json();
                        // Aqui poder√≠amos salvar o ID do contato no Supabase se tiv√©ssemos a coluna
                        // Mas o principal √© que ele agora existe l√° para futuras conversas
                        alert(`Contato ${deal.title} criado no Chatwoot com sucesso!`);
                    } else {
                        const err = await res.json();
                        console.warn("Contato j√° existe ou erro:", err);
                        // N√£o damos alert de erro aqui para n√£o travar o fluxo, pois pode ser duplicado
                    }
                } catch(e) {
                    console.error("Erro ao sincronizar contato:", e);
                }
            },

            saveDeal: async (e) => {
                e.preventDefault();
                if(!window.supabaseClient) return;

                const id = document.getElementById('dealId').value;
                const deal = {
                    title: document.getElementById('dealTitle').value,
                    company: document.getElementById('dealCompany').value,
                    email: document.getElementById('dealEmail').value,
                    phone: document.getElementById('dealPhone').value,
                    value: document.getElementById('dealValue').value || 0,
                    chatwoot_id: document.getElementById('dealChatId').value,
                    channel: document.getElementById('dealChannel').value,
                    meeting_date: document.getElementById('dealMeeting').value || null,
                    closing_date: document.getElementById('dealClosing').value || null,
                    conversation_start: document.getElementById('conversationStart').value || null,
                    notes: document.getElementById('dealNotes').value,
                };

                // Se for novo e tiver telefone/email, cria no Chatwoot
                if (!id && (deal.phone || deal.email)) {
                    await window.app.createChatwootContact(deal);
                }

                let error;
                if (id) {
                    const res = await window.supabaseClient.from('deals').update(deal).eq('id', id);
                    error = res.error;
                } else {
                    const res = await window.supabaseClient.from('deals').insert([{ ...deal, stage: 'prospeccao' }]);
                    error = res.error;
                }

                if (error) alert('Erro: ' + error.message);
                else {
                    window.ui.closeModal();
                    window.app.loadDeals();
                }
            },

            moveDeal: async (id, newStage) => {
                if(!window.supabaseClient) return;
                await window.supabaseClient.from('deals').update({ stage: newStage }).eq('id', id);
                window.app.loadDeals();
            },

            saveSettings: () => {
                localStorage.setItem('crm_sb_url', document.getElementById('sbUrl').value.trim());
                localStorage.setItem('crm_sb_key', document.getElementById('sbKey').value.trim());
                localStorage.setItem('crm_cw_url', document.getElementById('cwUrl').value.replace(/\/$/, ""));
                localStorage.setItem('crm_cw_token', document.getElementById('cwToken').value.trim());
                localStorage.setItem('crm_cw_account', document.getElementById('cwAccount').value.trim());
                location.reload();
            },

            exportCSV: async () => {
                if(!window.supabaseClient) return;
                const { data } = await window.supabaseClient.from('deals').select('*');
                if(!data || data.length === 0) return alert("Nada para exportar.");
                
                let csv = 'ID,Cliente,Empresa,Email,Telefone,Valor,Etapa,Canal,Data Reuniao,Prev. Fechamento,Chat ID\n';
                data.forEach(row => {
                    const safeTitle = (row.title || '').replace(/"/g, '""');
                    const safeCompany = (row.company || '').replace(/"/g, '""');
                    csv += `${row.id},"${safeTitle}","${safeCompany}","${row.email}","${row.phone}",${row.value},${row.stage},${row.channel},${row.meeting_date},${row.closing_date},${row.chatwoot_id}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = `crm_export_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            },

            archiveDeal: async () => {
                const id = document.getElementById('dealId').value;
                if(!id) return;
                const status = confirm("Neg√≥cio GANHO? (OK=Sim, Cancelar=Perdido)") ? 'won' : 'lost';
                await window.supabaseClient.from('deals').update({ status: 'archived', notes: `[${status}] ` + document.getElementById('dealNotes').value }).eq('id', id);
                window.ui.closeModal();
                window.app.loadDeals();
            }
        };

        window.ui = {
            renderBoard: () => {
                const board = document.getElementById('board');
                board.innerHTML = '';
                Object.entries(config.stages).forEach(([key, info]) => {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col w-[320px] min-w-[320px] max-h-full';
                    col.innerHTML = `
                        <div class="flex justify-between items-center mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full ${info.color.replace('border', 'bg')}"></span>
                                <h3 class="font-bold text-gray-700 uppercase text-xs tracking-wider">${info.title}</h3>
                            </div>
                            <span class="count bg-white px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-500 shadow-sm border">0</span>
                        </div>
                        <div class="kanban-list flex-1 bg-gray-100/50 rounded-xl p-2 space-y-3 overflow-y-auto border border-gray-200/60 custom-scrollbar" id="col-${key}" data-stage="${key}"></div>
                    `;
                    board.appendChild(col);

                    if(typeof Sortable !== 'undefined') {
                        new Sortable(col.querySelector('.kanban-list'), {
                            group: 'deals',
                            animation: 150,
                            ghostClass: 'ghost-card',
                            onEnd: (evt) => {
                                if (evt.to.dataset.stage !== evt.from.dataset.stage) {
                                    window.app.moveDeal(evt.item.dataset.id, evt.to.dataset.stage);
                                }
                            }
                        });
                    }
                });
            },

            createCard: (deal) => {
                const el = document.createElement('div');
                el.className = 'deal-card bg-white p-4 rounded-lg shadow-sm border border-gray-100 cursor-pointer transition-all relative group';
                el.dataset.id = deal.id;
                el.onclick = (e) => {
                    if(!e.target.closest('a')) window.ui.editDeal(deal);
                };

                const val = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(deal.value);
                const date = new Date(deal.created_at).toLocaleDateString('pt-BR');
                
                // Icone do Canal
                let channelIcon = '';
                if(deal.channel) {
                    let iconClass = 'fa-globe';
                    let bgClass = 'channel-icon api';
                    if(deal.channel.toLowerCase().includes('whatsapp')) { iconClass = 'fa-whatsapp'; bgClass = 'channel-icon whatsapp'; }
                    else if(deal.channel.toLowerCase().includes('email')) { iconClass = 'fa-envelope'; bgClass = 'channel-icon email'; }
                    
                    channelIcon = `<span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] ${bgClass}"><i class="fa-brands ${iconClass}"></i></span>`;
                }

                // Tempo decorrido (Conversa)
                let timeBadge = '';
                if(deal.conversation_start) {
                    const days = Math.floor((new Date() - new Date(deal.conversation_start)) / (1000 * 60 * 60 * 24));
                    timeBadge = `<span class="text-[10px] text-gray-400 flex items-center gap-1" title="Dias desde o in√≠cio"><i class="fa-regular fa-clock"></i> ${days}d</span>`;
                }

                const chatLink = deal.chatwoot_id 
                    ? `<a href="${config.cwUrl}/app/accounts/${config.cwAccount}/conversations/${deal.chatwoot_id}" target="_blank" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1 font-medium" onclick="event.stopPropagation()">
                        <i class="fa-regular fa-comments"></i> Abrir Chat
                       </a>` : '';
                
                // Badge de Fechamento
                const closingBadge = deal.closing_date 
                    ? `<div class="text-[10px] bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100 flex items-center gap-1 ml-auto"><i class="fa-solid fa-flag-checkered"></i> ${new Date(deal.closing_date).toLocaleDateString().slice(0,5)}</div>` 
                    : '';

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">${channelIcon} <span class="text-[10px] font-bold text-gray-400 uppercase truncate max-w-[120px]">${deal.company || 'Particular'}</span></div>
                        <span class="text-[10px] text-gray-300">${date}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm mb-1 truncate">${deal.title}</h4>
                    <p class="font-mono text-xs text-gray-600 font-medium mb-3">${val}</p>
                    
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${deal.meeting_date ? `<div class="text-[10px] bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-100 flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${new Date(deal.meeting_date).toLocaleDateString().slice(0,5)}</div>` : ''}
                        ${closingBadge}
                    </div>

                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        ${chatLink}
                        ${timeBadge}
                    </div>
                `;
                return el;
            },

            editDeal: (deal) => {
                document.getElementById('dealId').value = deal.id;
                document.getElementById('dealTitle').value = deal.title;
                document.getElementById('dealCompany').value = deal.company || '';
                document.getElementById('dealEmail').value = deal.email || '';
                document.getElementById('dealPhone').value = deal.phone || '';
                document.getElementById('dealValue').value = deal.value;
                document.getElementById('dealChatId').value = deal.chatwoot_id || '';
                document.getElementById('dealChannel').value = deal.channel || '';
                document.getElementById('dealMeeting').value = deal.meeting_date ? new Date(deal.meeting_date).toISOString().slice(0,16) : '';
                document.getElementById('dealClosing').value = deal.closing_date || '';
                document.getElementById('conversationStart').value = deal.conversation_start || '';
                document.getElementById('dealNotes').value = deal.notes || '';
                
                document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> Editar Neg√≥cio';
                document.getElementById('btnArchive').classList.remove('hidden');
                document.getElementById('dealModal').classList.remove('hidden');
            },

            openModal: () => {
                document.getElementById('dealForm').reset();
                document.getElementById('dealId').value = '';
                document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Novo Neg√≥cio';
                document.getElementById('btnArchive').classList.add('hidden');
                document.getElementById('dealModal').classList.remove('hidden');
            },

            closeModal: () => document.getElementById('dealModal').classList.add('hidden'),

            toggleSettings: () => {
                const m = document.getElementById('settingsModal');
                m.classList.toggle('hidden');
                if(!m.classList.contains('hidden')){
                    document.getElementById('sbUrl').value = config.sbUrl;
                    document.getElementById('sbKey').value = config.sbKey;
                    document.getElementById('cwUrl').value = config.cwUrl;
                    document.getElementById('cwToken').value = config.cwToken;
                    document.getElementById('cwAccount').value = config.cwAccount;
                }
            },
            
            updateCounts: () => {
                document.querySelectorAll('.kanban-list').forEach(list => {
                    list.previousElementSibling.querySelector('.count').innerText = list.children.length;
                });
            }
        };

        document.addEventListener('DOMContentLoaded', window.app.init);
    </script>
</body>
</html>

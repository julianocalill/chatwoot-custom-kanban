<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM BeMore</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Estilos dos Cards */
        .ghost-card { background: #eff6ff; border: 2px dashed #3b82f6; opacity: 0.5; }
        .dark .ghost-card { background: #1e293b; border-color: #3b82f6; }
        .deal-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Badges de Canal */
        .channel-icon.whatsapp { color: #25D366; background: #dcf8c6; }
        .channel-icon.web_widget { color: #3b82f6; background: #dbeafe; }
        .channel-icon.api { color: #8b5cf6; background: #ede9fe; }
        .channel-icon.email { color: #ea580c; background: #ffedd5; }
        
        /* Dark Mode Badges */
        .dark .channel-icon.whatsapp { background: #064e3b; color: #4ade80; }
        .dark .channel-icon.web_widget { background: #1e3a8a; color: #60a5fa; }
        .dark .channel-icon.api { background: #4c1d95; color: #a78bfa; }
        .dark .channel-icon.email { background: #7c2d12; color: #fdba74; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm text-gray-700 bg-slate-50 dark:bg-slate-900 dark:text-gray-200 transition-colors duration-300">

    <div class="bg-white dark:bg-slate-800 border-b dark:border-slate-700 px-6 py-3 flex justify-between items-center shadow-sm z-20 transition-colors">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-xl text-gray-800 dark:text-white tracking-tight flex items-center gap-2">
                <i class="fa-solid fa-rocket text-blue-600"></i> BeMore CRM
            </h1>
            <div id="total-pipeline" class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 px-3 py-1 rounded-full text-xs font-bold border border-green-200 dark:border-green-800">
                R$ 0,00
            </div>
        </div>
        <div class="flex gap-2">
             <button onclick="window.ui.openProductsModal()" class="flex items-center gap-2 px-3 py-2 bg-orange-50 hover:bg-orange-100 dark:bg-orange-900/30 dark:hover:bg-orange-900/50 rounded text-orange-600 dark:text-orange-300 transition border border-orange-200 dark:border-orange-800 font-medium">
                <i class="fa-solid fa-box-open"></i> Produtos
            </button>
             <button onclick="window.app.openReports()" class="flex items-center gap-2 px-3 py-2 bg-purple-50 hover:bg-purple-100 dark:bg-purple-900/30 dark:hover:bg-purple-900/50 text-purple-600 dark:text-purple-300 rounded transition border border-purple-200 dark:border-purple-800 font-medium">
                <i class="fa-solid fa-chart-pie"></i> Relat√≥rios
            </button>
             <button onclick="window.app.exportCSV()" class="flex items-center gap-2 px-3 py-2 bg-gray-50 hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 rounded text-gray-600 dark:text-gray-300 transition border dark:border-slate-600">
                <i class="fa-solid fa-download"></i> Exportar
            </button>
            <button onclick="window.ui.openModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium shadow-sm transition">
                <i class="fa-solid fa-plus"></i> Novo Neg√≥cio
            </button>
            <button onclick="window.ui.toggleSettings()" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div id="board" class="flex-1 overflow-x-auto overflow-y-hidden flex p-6 gap-6 items-start bg-slate-50 dark:bg-slate-900 transition-colors">
        <div class="m-auto text-gray-400 dark:text-gray-500 text-center animate-pulse">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i><br>Carregando sistema...
        </div>
    </div>

    <div id="productsModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-[400px] p-6 border dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white"><i class="fa-solid fa-box text-orange-500"></i> Gerenciar Produtos</h2>
                <button onclick="document.getElementById('productsModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500">&times;</button>
            </div>
            
            <form onsubmit="window.app.saveProduct(event)" class="flex gap-2 mb-4">
                <input type="text" id="newProductName" placeholder="Nome do Produto..." class="flex-1 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded p-2 outline-none focus:border-blue-500" required>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded font-bold">+</button>
            </form>

            <div id="productsList" class="max-h-60 overflow-y-auto space-y-2 custom-scrollbar"></div>
        </div>
    </div>

    <div id="reportsModal" class="fixed inset-0 bg-slate-900/90 hidden z-50 overflow-y-auto backdrop-blur-sm">
        <div class="min-h-screen px-10 py-10">
            <div class="flex justify-between items-center mb-8 max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-white"><i class="fa-solid fa-chart-line text-blue-500"></i> Dashboard</h2>
                <button onclick="document.getElementById('reportsModal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border dark:border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200">Funil (R$)</h3>
                    <div class="h-64"><canvas id="chartStage"></canvas></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border dark:border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200">Origem</h3>
                    <div class="h-64 flex justify-center"><canvas id="chartChannel"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="dealModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm overflow-y-auto py-10">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-[600px] p-6 transform transition-all scale-100 relative border dark:border-slate-700">
            <div class="flex justify-between items-center mb-6 border-b dark:border-slate-700 pb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2" id="modalTitle">
                    <i class="fa-regular fa-id-card"></i> Novo Neg√≥cio
                </h2>
                <button onclick="window.ui.closeModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            
            <form id="dealForm" onsubmit="window.app.saveDeal(event)">
                <input type="hidden" id="dealId">
                <input type="hidden" id="conversationStart">
                
                <div class="bg-blue-50 dark:bg-slate-700 p-4 rounded-lg mb-6 border border-blue-100 dark:border-slate-600">
                    <label class="block text-xs font-bold uppercase text-blue-600 dark:text-blue-400 mb-2">üîÑ Vincular Chatwoot</label>
                    <div class="flex gap-2">
                        <input type="text" id="dealPhone" class="flex-1 border border-blue-200 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Telefone ou ID da Conversa">
                        <button type="button" onclick="window.app.fetchChatwootData()" class="px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass"></i> Buscar
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Cliente / T√≠tulo</label>
                            <input type="text" id="dealTitle" required class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Empresa</label>
                            <input type="text" id="dealCompany" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">üì¶ Produto / Servi√ßo</label>
                        <select id="dealProduct" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none focus:border-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Email</label>
                            <input type="email" id="dealEmail" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none">
                        </div>
                         <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Canal</label>
                            <input type="text" id="dealChannel" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Valor (R$)</label>
                            <input type="number" id="dealValue" step="0.01" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Chat ID</label>
                            <input type="text" id="dealChatId" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-gray-300 rounded-lg p-2.5 bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-300 mb-1">Prev. Fechamento</label>
                            <input type="date" id="dealClosing" class="w-full border border-gray-200 dark:border-slate-500 dark:bg-slate-600 dark:text-white rounded-lg p-2.5 outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-300 mb-1">üìÖ Data Reuni√£o</label>
                        <input type="datetime-local" id="dealMeeting" class="w-full border border-gray-200 dark:border-slate-500 dark:bg-slate-600 dark:text-white rounded-lg p-2 outline-none">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1">Notas</label>
                        <textarea id="dealNotes" rows="3" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg p-2.5 outline-none"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-end items-center pt-4 border-t dark:border-slate-700 gap-3">
                    <button type="button" onclick="window.ui.closeModal()" class="px-5 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transform active:scale-95 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg w-96 p-6 shadow-2xl border dark:border-slate-700">
            <h2 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">üîå Conex√µes</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-2">Supabase</h3>
                    <input type="text" id="sbUrl" placeholder="Project URL" class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded text-xs mb-2">
                    <input type="password" id="sbKey" placeholder="Anon Key" class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded text-xs">
                </div>
                <div>
                    <h3 class="text-xs font-bold text-green-600 dark:text-green-400 uppercase mb-2">Chatwoot API</h3>
                    <input type="text" id="cwUrl" placeholder="URL" class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded text-xs mb-2">
                    <input type="text" id="cwToken" placeholder="Token" class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded text-xs mb-2">
                    <input type="text" id="cwAccount" placeholder="ID Conta" class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded text-xs">
                </div>
            </div>
            <button onclick="window.app.saveSettings()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold transition">Salvar</button>
        </div>
    </div>

    <script>
        const themeCheck = () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        };
        themeCheck();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', themeCheck);

        window.supabaseClient = null;
        window.myCharts = {};
        window.productsList = [];

        const config = {
            stages: {
                'prospeccao': { title: 'üîé Prospec√ß√£o', color: 'border-blue-500' },
                'qualificacao': { title: 'üí¨ Qualifica√ß√£o', color: 'border-yellow-500' },
                'proposta': { title: 'üìÑ Proposta', color: 'border-orange-500' },
                'negociacao': { title: 'ü§ù Negocia√ß√£o', color: 'border-purple-500' },
                // NOVAS COLUNAS FINAIS
                'ganho': { title: 'üèÜ Ganho', color: 'border-green-600' },
                'perdido': { title: '‚ùå Perdido', color: 'border-red-600' }
            },
            sbUrl: localStorage.getItem('crm_sb_url') || '',
            sbKey: localStorage.getItem('crm_sb_key') || '',
            cwUrl: localStorage.getItem('crm_cw_url') || '',
            cwToken: localStorage.getItem('crm_cw_token') || '',
            cwAccount: localStorage.getItem('crm_cw_account') || '1'
        };

        window.app = {
            dealsData: [],

            init: async () => {
                if (typeof window.supabase === 'undefined') return alert("Erro: Lib Supabase off.");
                if (!config.sbUrl || !config.sbKey) { window.ui.toggleSettings(); return; }
                try {
                    const { createClient } = window.supabase;
                    window.supabaseClient = createClient(config.sbUrl, config.sbKey);
                    window.ui.renderBoard();
                    await window.app.loadProducts();
                    await window.app.loadDeals();
                } catch (e) { alert("Erro ao iniciar: " + e.message); }
            },

            loadProducts: async () => {
                const { data, error } = await window.supabaseClient.from('products').select('*').order('name');
                if(!error && data) {
                    window.productsList = data;
                    window.ui.renderProductSelect();
                }
            },
            saveProduct: async (e) => {
                e.preventDefault();
                const name = document.getElementById('newProductName').value;
                if(!name) return;
                const { error } = await window.supabaseClient.from('products').insert([{ name }]);
                if(!error) {
                    document.getElementById('newProductName').value = '';
                    await window.app.loadProducts();
                    window.ui.renderProductsListModal();
                } else alert('Erro ao salvar produto');
            },
            deleteProduct: async (id) => {
                if(!confirm('Excluir este produto?')) return;
                await window.supabaseClient.from('products').delete().eq('id', id);
                await window.app.loadProducts();
                window.ui.renderProductsListModal();
            },

            loadDeals: async () => {
                if(!window.supabaseClient) return;
                // Carrega TUDO, inclusive os 'ganho' e 'perdido' pois agora s√£o colunas, n√£o status 'archived'
                const { data, error } = await window.supabaseClient.from('deals').select('*').neq('status', 'archived').order('created_at', { ascending: false });
                if (error) { if(error.code === '401') window.ui.toggleSettings(); return; }

                window.app.dealsData = data || [];
                document.querySelectorAll('.kanban-list').forEach(el => el.innerHTML = '');
                let total = 0;
                
                if(data) {
                    data.forEach(deal => {
                        const col = document.getElementById(`col-${deal.stage}`);
                        if (col) {
                            col.appendChild(window.ui.createCard(deal));
                            total += parseFloat(deal.value || 0);
                        }
                    });
                }
                document.getElementById('total-pipeline').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
                window.ui.updateCounts();
            },

            openReports: () => {
                document.getElementById('reportsModal').classList.remove('hidden');
                const deals = window.app.dealsData;
                const stageValues = {};
                Object.keys(config.stages).forEach(k => stageValues[k] = 0);
                deals.forEach(d => { if(stageValues[d.stage] !== undefined) stageValues[d.stage] += parseFloat(d.value || 0); });

                const channels = {};
                deals.forEach(d => {
                    let ch = d.channel ? d.channel.split('::')[0] : 'Manual';
                    if(ch === 'api') ch = 'API';
                    channels[ch] = (channels[ch] || 0) + 1;
                });

                window.app.renderChart('chartStage', 'bar', 'Pipeline (R$)', Object.keys(stageValues).map(k => config.stages[k].title), Object.values(stageValues));
                window.app.renderChart('chartChannel', 'doughnut', 'Origem', Object.keys(channels), Object.values(channels));
            },

            renderChart: (canvasId, type, label, labels, data) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if(window.myCharts[canvasId]) window.myCharts[canvasId].destroy();
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e2e8f0' : '#475569';

                window.myCharts[canvasId] = new Chart(ctx, {
                    type: type,
                    data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: ['#3b82f6', '#eab308', '#f97316', '#a855f7', '#22c55e', '#ef4444'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } }, scales: type === 'bar' ? { y: { ticks: { color: textColor }, grid: { color: isDark ? '#334155' : '#e2e8f0' } }, x: { ticks: { color: textColor }, grid: { display: false } } } : {} }
                });
            },

            fetchChatwootData: async () => {
                const query = document.getElementById('dealPhone').value.trim();
                if(!query || !config.cwToken) return alert("Verifique dados e token.");
                const btn = document.querySelector('button[onclick="window.app.fetchChatwootData()"]');
                const oldHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    let url = `${config.cwUrl}/api/v1/accounts/${config.cwAccount}/contacts/search?q=${query}`;
                    let res = await fetch(url, { headers: { 'api_access_token': config.cwToken } });
                    let json = await res.json();
                    let contact = json.payload?.[0];

                    if(!contact && !isNaN(query)) {
                        let cRes = await fetch(`${config.cwUrl}/api/v1/accounts/${config.cwAccount}/conversations/${query}`, { headers: { 'api_access_token': config.cwToken } });
                        if(cRes.ok) {
                            let cJson = await cRes.json();
                            contact = cJson.meta.sender;
                            document.getElementById('dealChatId').value = cJson.id;
                            document.getElementById('dealChannel').value = cJson.meta.channel;
                            if(cJson.created_at) document.getElementById('conversationStart').value = new Date(cJson.created_at * 1000).toISOString();
                        }
                    }

                    if(contact) {
                        document.getElementById('dealTitle').value = contact.name || '';
                        document.getElementById('dealEmail').value = contact.email || '';
                        document.getElementById('dealPhone').value = contact.phone_number || query;
                        if(contact.additional_attributes?.company_name) document.getElementById('dealCompany').value = contact.additional_attributes.company_name;
                        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                    } else alert("N√£o encontrado.");
                } catch(e) { console.error(e); }
                setTimeout(() => btn.innerHTML = oldHtml, 2000);
            },

            createChatwootContact: async (deal) => {
                 if(!config.cwUrl || !config.cwToken) return;
                 try {
                    await fetch(`${config.cwUrl}/api/v1/accounts/${config.cwAccount}/contacts`, {
                        method: 'POST', headers: { 'api_access_token': config.cwToken, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: deal.title, email: deal.email, phone_number: deal.phone, company_name: deal.company })
                    });
                 } catch(e) {}
            },

            saveDeal: async (e) => {
                e.preventDefault();
                if(!window.supabaseClient) return;

                const id = document.getElementById('dealId').value;
                const deal = {
                    title: document.getElementById('dealTitle').value,
                    company: document.getElementById('dealCompany').value,
                    product: document.getElementById('dealProduct').value,
                    email: document.getElementById('dealEmail').value,
                    phone: document.getElementById('dealPhone').value,
                    value: document.getElementById('dealValue').value || 0,
                    chatwoot_id: document.getElementById('dealChatId').value,
                    channel: document.getElementById('dealChannel').value,
                    meeting_date: document.getElementById('dealMeeting').value || null,
                    closing_date: document.getElementById('dealClosing').value || null,
                    conversation_start: document.getElementById('conversationStart').value || null,
                    notes: document.getElementById('dealNotes').value,
                };

                if (!id && (deal.phone || deal.email)) await window.app.createChatwootContact(deal);

                let error;
                if (id) error = (await window.supabaseClient.from('deals').update(deal).eq('id', id)).error;
                else error = (await window.supabaseClient.from('deals').insert([{ ...deal, stage: 'prospeccao' }])).error;

                if (error) alert('Erro: ' + error.message);
                else { window.ui.closeModal(); window.app.loadDeals(); }
            },

            moveDeal: async (id, newStage) => {
                await window.supabaseClient.from('deals').update({ stage: newStage }).eq('id', id);
                window.app.loadDeals();
            },

            saveSettings: () => {
                localStorage.setItem('crm_sb_url', document.getElementById('sbUrl').value.trim());
                localStorage.setItem('crm_sb_key', document.getElementById('sbKey').value.trim());
                localStorage.setItem('crm_cw_url', document.getElementById('cwUrl').value.replace(/\/$/, ""));
                localStorage.setItem('crm_cw_token', document.getElementById('cwToken').value.trim());
                localStorage.setItem('crm_cw_account', document.getElementById('cwAccount').value.trim());
                location.reload();
            },

            exportCSV: async () => {
                const { data } = await window.supabaseClient.from('deals').select('*');
                if(!data?.length) return alert("Nada para exportar.");
                let csv = 'ID,Cliente,Empresa,Produto,Email,Valor,Etapa,Canal\n';
                data.forEach(r => csv += `${r.id},"${r.title}","${r.company||''}","${r.product||''}","${r.email||''}",${r.value},${r.stage},${r.channel||''}\n`);
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
                a.download = `crm_export.csv`;
                a.click();
            }
        };

        window.ui = {
            renderBoard: () => {
                const board = document.getElementById('board');
                board.innerHTML = '';
                Object.entries(config.stages).forEach(([key, info]) => {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col w-[320px] min-w-[320px] max-h-full';
                    col.innerHTML = `
                        <div class="flex justify-between items-center mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full ${info.color.replace('border', 'bg')}"></span>
                                <h3 class="font-bold text-gray-700 dark:text-gray-300 uppercase text-xs tracking-wider">${info.title}</h3>
                            </div>
                            <span class="count bg-white dark:bg-slate-700 px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-500 dark:text-gray-300 shadow-sm border dark:border-slate-600">0</span>
                        </div>
                        <div class="kanban-list flex-1 bg-gray-100/50 dark:bg-slate-800/50 rounded-xl p-2 space-y-3 overflow-y-auto border border-gray-200/60 dark:border-slate-700/60 custom-scrollbar" id="col-${key}" data-stage="${key}"></div>
                    `;
                    board.appendChild(col);
                    if(typeof Sortable !== 'undefined') new Sortable(col.querySelector('.kanban-list'), { group: 'deals', animation: 150, ghostClass: 'ghost-card', onEnd: (evt) => { if (evt.to.dataset.stage !== evt.from.dataset.stage) window.app.moveDeal(evt.item.dataset.id, evt.to.dataset.stage); } });
                });
            },

            createCard: (deal) => {
                const el = document.createElement('div');
                el.className = 'deal-card bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-slate-700 cursor-pointer transition-all relative group';
                el.dataset.id = deal.id;
                el.onclick = (e) => { if(!e.target.closest('a')) window.ui.editDeal(deal); };

                const val = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(deal.value);
                const date = new Date(deal.created_at).toLocaleDateString('pt-BR');
                
                let channelIcon = '';
                if(deal.channel) {
                    let iconClass = 'fa-globe', bgClass = 'channel-icon api';
                    if(deal.channel.toLowerCase().includes('whatsapp')) { iconClass = 'fa-whatsapp'; bgClass = 'channel-icon whatsapp'; }
                    else if(deal.channel.toLowerCase().includes('email')) { iconClass = 'fa-envelope'; bgClass = 'channel-icon email'; }
                    channelIcon = `<span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] ${bgClass}"><i class="fa-brands ${iconClass}"></i></span>`;
                }

                let chatLink = deal.chatwoot_id ? `<a href="${config.cwUrl}/app/accounts/${config.cwAccount}/conversations/${deal.chatwoot_id}" target="_blank" class="text-xs bg-blue-50 dark:bg-slate-700 text-blue-600 dark:text-blue-400 px-2 py-1 rounded hover:bg-blue-100 dark:hover:bg-slate-600 flex items-center gap-1 font-medium" onclick="event.stopPropagation()"><i class="fa-regular fa-comments"></i> Chat</a>` : '';
                let productBadge = deal.product ? `<span class="text-[10px] bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-2 py-0.5 rounded border border-orange-200 dark:border-orange-800 font-semibold mb-2 inline-block"><i class="fa-solid fa-box"></i> ${deal.product}</span>` : '';
                
                // DATA DE FECHAMENTO (CORRIGIDO PARA SER BEM VIS√çVEL)
                let closingBadge = deal.closing_date 
                    ? `<div class="text-[10px] bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 px-2 py-1 rounded border border-purple-200 dark:border-purple-800 flex items-center gap-1"><i class="fa-solid fa-flag-checkered"></i> ${new Date(deal.closing_date).toLocaleDateString().slice(0,5)}</div>` 
                    : '';

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">${channelIcon} <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase truncate max-w-[120px]">${deal.company || 'Particular'}</span></div>
                        <span class="text-[10px] text-gray-300 dark:text-gray-600">${date}</span>
                    </div>
                    ${productBadge}
                    <h4 class="font-bold text-gray-800 dark:text-gray-200 text-sm mb-1 truncate">${deal.title}</h4>
                    <p class="font-mono text-xs text-gray-600 dark:text-gray-400 font-medium mb-3">${val}</p>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${deal.meeting_date ? `<div class="text-[10px] bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 px-2 py-1 rounded border border-yellow-100 dark:border-yellow-800 flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${new Date(deal.meeting_date).toLocaleDateString().slice(0,5)}</div>` : ''}
                        ${closingBadge}
                    </div>

                    <div class="flex justify-between items-center border-t dark:border-slate-700 pt-2">${chatLink}</div>
                `;
                return el;
            },

            editDeal: (deal) => {
                document.getElementById('dealId').value = deal.id;
                document.getElementById('dealTitle').value = deal.title;
                document.getElementById('dealCompany').value = deal.company || '';
                document.getElementById('dealProduct').value = deal.product || '';
                document.getElementById('dealEmail').value = deal.email || '';
                document.getElementById('dealPhone').value = deal.phone || '';
                document.getElementById('dealValue').value = deal.value;
                document.getElementById('dealChatId').value = deal.chatwoot_id || '';
                document.getElementById('dealChannel').value = deal.channel || '';
                document.getElementById('dealMeeting').value = deal.meeting_date ? new Date(deal.meeting_date).toISOString().slice(0,16) : '';
                document.getElementById('dealClosing').value = deal.closing_date || '';
                document.getElementById('conversationStart').value = deal.conversation_start || '';
                document.getElementById('dealNotes').value = deal.notes || '';
                
                document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> Editar Neg√≥cio';
                document.getElementById('dealModal').classList.remove('hidden');
            },

            openModal: () => {
                document.getElementById('dealForm').reset();
                document.getElementById('dealId').value = '';
                document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Novo Neg√≥cio';
                document.getElementById('dealModal').classList.remove('hidden');
            },
            closeModal: () => document.getElementById('dealModal').classList.add('hidden'),

            openProductsModal: () => {
                document.getElementById('productsModal').classList.remove('hidden');
                window.ui.renderProductsListModal();
            },
            renderProductSelect: () => {
                const select = document.getElementById('dealProduct');
                select.innerHTML = '<option value="">Selecione...</option>' + window.productsList.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            },
            renderProductsListModal: () => {
                const list = document.getElementById('productsList');
                list.innerHTML = window.productsList.map(p => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-slate-700 p-2 rounded">
                        <span class="text-gray-700 dark:text-gray-200">${p.name}</span>
                        <button onclick="window.app.deleteProduct(${p.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
            },

            toggleSettings: () => {
                const m = document.getElementById('settingsModal');
                m.classList.toggle('hidden');
                if(!m.classList.contains('hidden')){
                    document.getElementById('sbUrl').value = config.sbUrl;
                    document.getElementById('sbKey').value = config.sbKey;
                    document.getElementById('cwUrl').value = config.cwUrl;
                    document.getElementById('cwToken').value = config.cwToken;
                    document.getElementById('cwAccount').value = config.cwAccount;
                }
            },
            updateCounts: () => { document.querySelectorAll('.kanban-list').forEach(l => l.previousElementSibling.querySelector('.count').innerText = l.children.length); }
        };

        document.addEventListener('DOMContentLoaded', window.app.init);
    </script>
</body>
</html>

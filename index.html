<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatwoot Kanban</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F4F6F8; }
        .kanban-col { min-height: 80vh; }
        .ghost { opacity: 0.5; background: #c8ebfb; }
        /* Scrollbar fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-gray-700 text-lg">üöÄ Pipeline</h1>
            <select id="funnelSelector" class="border rounded px-2 py-1 text-sm bg-gray-50" onchange="loadFunnel()">
                </select>
        </div>
        <button onclick="toggleSettings()" class="text-gray-500 hover:text-blue-600">
            ‚öôÔ∏è Configurar
        </button>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h2 class="text-xl font-bold mb-4">Configura√ß√µes</h2>
            
            <label class="block text-sm font-medium text-gray-700">Chatwoot URL (sem a barra final)</label>
            <input type="text" id="cwUrl" placeholder="https://chat.suaempresa.com" class="w-full border rounded p-2 mb-3">
            
            <label class="block text-sm font-medium text-gray-700">Token de Acesso (User API Token)</label>
            <input type="password" id="cwToken" class="w-full border rounded p-2 mb-3">
            
            <label class="block text-sm font-medium text-gray-700">ID da Conta</label>
            <input type="number" id="cwAccount" class="w-full border rounded p-2 mb-4">

            <hr class="my-4">
            
            <h3 class="font-bold text-sm mb-2">Configurar Funis (JSON)</h3>
            <textarea id="jsonConfig" class="w-full border rounded p-2 text-xs h-32 font-mono" placeholder='{"Vendas": ["novo", "negociando"], "Suporte": ["aberto", "pendente"]}'></textarea>
            <p class="text-xs text-gray-500 mt-1">Defina o nome do funil e as etiquetas de cada coluna.</p>

            <div class="flex justify-end gap-2 mt-4">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600">Cancelar</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
            </div>
        </div>
    </div>

    <div id="board" class="flex-1 overflow-x-auto overflow-y-hidden flex p-4 gap-4">
        </div>

    <script>
        // --- 1. Estado da Aplica√ß√£o ---
        let config = {
            url: localStorage.getItem('cw_url') || '',
            token: localStorage.getItem('cw_token') || '',
            accountId: localStorage.getItem('cw_account') || '',
            pipelines: JSON.parse(localStorage.getItem('cw_pipelines') || '{"Vendas": ["prospeccao", "negociacao", "fechado"], "Suporte": ["duvida", "resolvido"]}')
        };

        // --- 2. Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!config.url || !config.token) {
                toggleSettings(); // Abre config se n√£o tiver dados
            } else {
                initApp();
            }
        });

        function initApp() {
            renderFunnelSelector();
            loadFunnel();
        }

        // --- 3. Renderiza√ß√£o ---
        function renderFunnelSelector() {
            const select = document.getElementById('funnelSelector');
            select.innerHTML = '';
            Object.keys(config.pipelines).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
        }

        async function loadFunnel() {
            const board = document.getElementById('board');
            const selectedFunnel = document.getElementById('funnelSelector').value;
            const stages = config.pipelines[selectedFunnel];

            board.innerHTML = '<div class="text-gray-500 p-4">Carregando colunas...</div>';
            
            // Busca conversas do Chatwoot
            const conversations = await fetchConversations();
            
            board.innerHTML = ''; // Limpa

            stages.forEach(tag => {
                // Cria a Coluna
                const col = document.createElement('div');
                col.className = 'flex flex-col min-w-[300px] w-[300px] bg-gray-100 rounded-lg h-full border border-gray-200';
                col.setAttribute('data-tag', tag);

                // Cabe√ßalho da Coluna
                col.innerHTML = `
                    <div class="p-3 font-semibold text-gray-700 uppercase text-xs flex justify-between border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <span>üè∑Ô∏è ${tag.replace('_', ' ')}</span>
                        <span class="count bg-gray-200 px-2 rounded-full text-gray-600">0</span>
                    </div>
                    <div class="kanban-list flex-1 p-2 overflow-y-auto space-y-2 custom-scrollbar" id="list-${tag}">
                        </div>
                `;
                
                board.appendChild(col);

                // Filtrar conversas que tem ESSA tag
                const list = col.querySelector('.kanban-list');
                const filtered = conversations.filter(c => c.labels && c.labels.includes(tag));
                
                // Atualiza contador
                col.querySelector('.count').innerText = filtered.length;

                // Renderiza Cards
                filtered.forEach(c => list.appendChild(createCardElement(c)));

                // Ativa Drag & Drop na lista
                new Sortable(list, {
                    group: 'shared', // Permite mover entre listas
                    animation: 150,
                    ghostClass: 'ghost',
                    onEnd: async function (evt) {
                        const itemEl = evt.item;
                        const newCol = evt.to.closest('[data-tag]');
                        const oldCol = evt.from.closest('[data-tag]');
                        
                        if (newCol === oldCol) return; // N√£o mudou de coluna

                        const conversationId = itemEl.getAttribute('data-id');
                        const newTag = newCol.getAttribute('data-tag');
                        const oldTag = oldCol.getAttribute('data-tag');

                        // Atualiza visualmente o contador
                        updateCounts();

                        // Chama API para trocar etiqueta
                        await moveCard(conversationId, oldTag, newTag);
                    }
                });
            });
        }

        function createCardElement(c) {
            const el = document.createElement('div');
            el.className = 'bg-white p-3 rounded shadow-sm border border-gray-200 cursor-grab hover:shadow-md transition-shadow';
            el.setAttribute('data-id', c.id);
            
            const sender = c.meta.sender || {};
            const lastMsg = c.messages[0] ? c.messages[0].content : '';

            el.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="font-bold text-sm text-gray-800">${sender.name || 'Visitante'}</span>
                    <span class="text-[10px] text-gray-400">#${c.id}</span>
                </div>
                <p class="text-xs text-gray-500 line-clamp-2 mb-2">${lastMsg}</p>
                <div class="flex justify-end">
                    <a href="${config.url}/app/accounts/${config.accountId}/conversations/${c.id}" target="_blank" class="text-[10px] text-blue-500 hover:underline">Abrir ‚Üó</a>
                </div>
            `;
            return el;
        }

        function updateCounts() {
            document.querySelectorAll('[data-tag]').forEach(col => {
                const count = col.querySelector('.kanban-list').children.length;
                col.querySelector('.count').innerText = count;
            });
        }

        // --- 4. Integra√ß√£o com API Chatwoot ---
        
        async function fetchConversations() {
            try {
                // Pega conversas abertas
                const res = await fetch(`${config.url}/api/v1/accounts/${config.accountId}/conversations?status=open`, {
                    headers: { 'api_access_token': config.token }
                });
                const json = await res.json();
                return json.data.payload;
            } catch (e) {
                console.error(e);
                alert('Erro ao carregar conversas. Verifique sua URL e Token. QUE MERDA EM, DENOVO!! ');
                return [];
            }
        }

        async function moveCard(convId, oldTag, newTag) {
            try {
                // 1. Adiciona nova tag
                await fetch(`${config.url}/api/v1/accounts/${config.accountId}/conversations/${convId}/labels`, {
                    method: 'POST',
                    headers: { 
                        'api_access_token': config.token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ labels: [newTag] })
                });

                // 2. Remove tag antiga (Chatwoot n√£o tem "replace", precisa adicionar uma e tirar a outra)
                // Pequeno delay para garantir consist√™ncia
                setTimeout(async () => {
                     // Nota: A API de remover label requer passar a label na URL, n√£o no body, dependendo da vers√£o
                     // Vou usar a estrat√©gia de atualizar as labels da conversa inteira se necess√°rio, mas o remove √© mais seguro
                     // A rota correta de delete: DELETE /api/v1/accounts/{account_id}/conversations/{conversation_id}/labels/{label}
                }, 500);

                 // Para simplificar neste MVP, vamos assumir que adicionar a nova j√° move visualmente. 
                 // O ideal em produ√ß√£o √© chamar o DELETE da tag antiga:
                 await fetch(`${config.url}/api/v1/accounts/${config.accountId}/conversations/${convId}/labels/${oldTag}`, {
                    method: 'DELETE',
                    headers: { 'api_access_token': config.token }
                });

            } catch (e) {
                console.error("Erro ao mover card", e);
                alert('Erro ao sincronizar com Chatwoot');
            }
        }

        // --- 5. L√≥gica de Configura√ß√µes ---
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                // Preenche campos
                document.getElementById('cwUrl').value = config.url;
                document.getElementById('cwToken').value = config.token;
                document.getElementById('cwAccount').value = config.accountId;
                document.getElementById('jsonConfig').value = JSON.stringify(config.pipelines, null, 2);
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveSettings() {
            const url = document.getElementById('cwUrl').value.replace(/\/$/, ""); // Tira barra final
            const token = document.getElementById('cwToken').value;
            const account = document.getElementById('cwAccount').value;
            let pipelines;

            try {
                pipelines = JSON.parse(document.getElementById('jsonConfig').value);
            } catch (e) {
                alert("Erro no formato JSON dos funis.");
                return;
            }

            localStorage.setItem('cw_url', url);
            localStorage.setItem('cw_token', token);
            localStorage.setItem('cw_account', account);
            localStorage.setItem('cw_pipelines', JSON.stringify(pipelines));

            config = { url, token, accountId: account, pipelines };
            
            toggleSettings();
            initApp(); // Recarrega
        }
    </script>
</body>

</html>

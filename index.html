<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeMore CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#0B0E14',
                        card: '#151A25',
                        border: '#2A303C',
                        primary: '#3B82F6',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B0E14; color: #F3F4F6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #2A303C; border-radius: 4px; }
        .ghost-card { background: #1e293b; border: 2px dashed #3b82f6; opacity: 0.5; }
        .deal-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm bg-bg text-gray-200">

    <div class="bg-card border-b border-border px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-lg text-white flex items-center gap-2">
                <i class="fa-solid fa-rocket text-primary"></i> BeMore CRM
            </h1>
            <div id="total-pipeline" class="bg-primary/20 text-primary px-3 py-1 rounded-full text-xs font-bold border border-primary/30">R$ 0,00</div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="window.ui.openReasonsManager()" class="flex items-center gap-2 px-3 py-2 bg-card hover:bg-white/5 border border-border rounded text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-thumbs-down"></i> Motivos
            </button>
            <button onclick="window.ui.openReports()" class="flex items-center gap-2 px-3 py-2 bg-card hover:bg-white/5 border border-border rounded text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-chart-pie"></i> Relatórios
            </button>
            <button onclick="window.app.exportCSV()" class="flex items-center gap-2 px-3 py-2 bg-card hover:bg-white/5 border border-border rounded text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-file-csv"></i> Exportar
            </button>
            
            <div class="w-[1px] h-8 bg-border mx-1"></div>

            <button onclick="window.ui.openModal()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded font-medium shadow-lg shadow-blue-500/20 transition">
                <i class="fa-solid fa-plus"></i> Novo
            </button>
            <button onclick="window.ui.toggleSettings()" class="p-2 text-gray-400 hover:text-white transition ml-1"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div id="board" class="flex-1 overflow-x-auto overflow-y-hidden flex p-6 gap-6 items-start bg-bg"></div>

    <div id="dealModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-card rounded-xl shadow-2xl w-[900px] border border-border flex flex-col md:flex-row max-h-[90vh] overflow-hidden">
            <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6 border-b border-border pb-4">
                    <h2 class="text-xl font-bold text-white" id="modalTitle">Novo Negócio</h2>
                    <button type="button" onclick="window.ui.closeModal()" class="text-gray-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <form id="dealForm" onsubmit="window.app.saveDeal(event)">
                    <input type="hidden" id="dealId">
                    <input type="hidden" id="dealChatId">
                    <div class="bg-blue-500/10 p-3 rounded-lg mb-4 border border-blue-500/20 flex gap-2">
                        <input type="text" id="dealPhone" class="flex-1 bg-bg border border-border rounded p-2 text-white text-xs outline-none focus:border-primary" placeholder="Telefone ou ID Chatwoot...">
                        <button type="button" onclick="window.app.fetchChatwootData()" class="px-3 bg-primary text-white rounded hover:bg-blue-600"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] uppercase font-bold text-gray-500">Cliente</label><input type="text" id="dealTitle" required class="w-full bg-bg border border-border rounded p-2 text-white focus:border-primary outline-none"></div>
                            <div><label class="text-[10px] uppercase font-bold text-gray-500">Email</label><input type="email" id="dealEmail" class="w-full bg-bg border border-border rounded p-2 text-white focus:border-primary outline-none"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-primary">Veículo (Estoque)</label>
                                <select id="dealProduct" onchange="window.app.autoFillPrice()" class="w-full bg-bg border border-border rounded p-2 text-white focus:border-primary outline-none"><option value="">Carregando...</option></select>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">Status Insucesso</label>
                                <select id="dealInsucesso" class="w-full bg-bg border border-border rounded p-2 text-gray-300 focus:border-primary outline-none">
                                    <option value="">Nenhum...</option>
                                    <option value="NAO ATENDE / NAO RESPONDE">NAO ATENDE / NAO RESPONDE</option>
                                    <option value="NAO CONSEGUE RETIRAR / DDD LONGE">NAO CONSEGUE RETIRAR / DDD LONGE</option>
                                    <option value="AVALIAÇÃO V.U ABAIXO DO ESPERADO">AVALIAÇÃO V.U ABAIXO DO ESPERADO</option>
                                    <option value="PARCELA FORA DO ESPERADO">PARCELA FORA DO ESPERADO</option>
                                    <option value="COMPRA FUTURA">COMPRA FUTURA</option>
                                    <option value="SEM INTENÇÃO DE COMPRA">SEM INTENÇÃO DE COMPRA</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] uppercase font-bold text-gray-500">Valor (R$)</label><input type="number" id="dealValue" step="0.01" class="w-full bg-bg border border-border rounded p-2 text-white focus:border-primary outline-none font-mono"></div>
                            <div><label class="text-[10px] uppercase font-bold text-gray-500">Prev. Fechamento</label><input type="date" id="dealClosing" class="w-full bg-bg border border-border rounded p-2 text-white focus:border-primary outline-none"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between items-center pt-4 border-t border-border">
                        <button type="button" onclick="window.app.deleteDeal()" id="btnDelete" class="text-red-500 hover:text-red-400 hidden"><i class="fa-solid fa-trash-can"></i></button>
                        <div class="flex gap-2 ml-auto">
                            <button type="button" onclick="window.ui.closeModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancelar</button>
                            <button type="button" onclick="window.app.requestLoss()" id="btnLoss" class="hidden px-3 py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded font-bold uppercase text-xs">Perdido</button>
                            <button type="button" onclick="window.app.saveDeal(event, 'ganho')" id="btnWin" class="hidden px-3 py-2 bg-green-500/10 text-green-400 border border-green-500/20 rounded font-bold uppercase text-xs">Ganho</button>
                            <button type="submit" class="px-6 py-2 bg-primary text-white rounded font-bold hover:bg-blue-600 shadow-lg">Salvar</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="w-full md:w-[300px] bg-bg border-l border-border flex flex-col">
                <div class="p-3 border-b border-border bg-card/50"><h3 class="font-bold text-gray-400 text-xs uppercase"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</h3></div>
                <div id="timelineList" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar text-xs"><div class="text-center text-gray-500 mt-10">Selecione um negócio.</div></div>
                <div class="p-3 border-t border-border bg-card">
                    <form onsubmit="window.app.addNote(event)" class="relative"><input type="text" id="newNoteInput" placeholder="Adicionar nota..." class="w-full bg-bg border border-border rounded-full py-2 pl-3 pr-10 text-white outline-none focus:border-primary"><button type="submit" class="absolute right-1 top-1 w-7 h-7 bg-primary text-white rounded-full flex items-center justify-center hover:bg-blue-600"><i class="fa-solid fa-paper-plane text-[10px]"></i></button></form>
                </div>
            </div>
        </div>
    </div>

    <div id="reportsModal" class="fixed inset-0 bg-black/90 hidden z-[60] overflow-y-auto backdrop-blur-sm p-10">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white"><i class="fa-solid fa-chart-line text-primary"></i> Relatórios CRM</h2>
                <button onclick="document.getElementById('reportsModal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg">
                    <h3 class="text-lg font-bold mb-4 text-white">Funil de Vendas (Valor R$)</h3>
                    <div class="h-64"><canvas id="chartStage"></canvas></div>
                </div>
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg">
                    <h3 class="text-lg font-bold mb-4 text-white">Motivos de Perda</h3>
                    <div class="h-64"><canvas id="chartLoss"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="reasonsManagerModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-card border border-border rounded-xl p-6 w-96">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white">Motivos de Perda</h2>
                <button onclick="document.getElementById('reasonsManagerModal').classList.add('hidden')" class="text-gray-400">x</button>
            </div>
            <form onsubmit="window.app.saveReason(event)" class="flex gap-2 mb-4">
                <input type="text" id="newReasonName" placeholder="Novo motivo..." class="flex-1 bg-bg border border-border rounded p-2 text-white outline-none" required>
                <button type="submit" class="bg-primary hover:bg-blue-600 text-white px-4 rounded font-bold">+</button>
            </form>
            <div id="reasonsList" class="max-h-60 overflow-y-auto space-y-2 custom-scrollbar"></div>
        </div>
    </div>

    <div id="selectReasonModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[70] backdrop-blur-sm">
        <div class="bg-card border border-border rounded-xl p-6 w-80 text-center">
            <h2 class="text-lg font-bold text-white mb-4">Motivo da Perda</h2>
            <select id="lossReasonSelect" class="w-full bg-bg border border-border rounded p-2 text-white mb-4 outline-none"><option value="">Carregando...</option></select>
            <div class="flex gap-2 justify-center">
                <button onclick="window.ui.cancelLoss()" class="px-4 py-2 text-gray-400">Cancelar</button>
                <button onclick="window.ui.confirmLoss()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80]">
        <div class="bg-card border border-border rounded-xl w-96 p-6 shadow-2xl">
            <h2 class="font-bold text-lg text-white mb-4">Configurações</h2>
            <input type="text" id="sbUrl" placeholder="Supabase URL" class="w-full bg-bg border border-border p-2 rounded text-white mb-3 text-xs">
            <input type="password" id="sbKey" placeholder="Supabase Key" class="w-full bg-bg border border-border p-2 rounded text-white mb-3 text-xs">
            <input type="text" id="cwUrl" placeholder="Chatwoot URL" class="w-full bg-bg border border-border p-2 rounded text-white mb-3 text-xs">
            <input type="password" id="cwToken" placeholder="Chatwoot Token" class="w-full bg-bg border border-border p-2 rounded text-white mb-3 text-xs">
            <input type="text" id="cwAccount" placeholder="Account ID" class="w-full bg-bg border border-border p-2 rounded text-white mb-4 text-xs">
            <button onclick="window.app.saveSettings()" class="w-full bg-primary hover:bg-blue-600 text-white py-2 rounded font-bold">Salvar</button>
            <button onclick="window.ui.toggleSettings()" class="w-full text-gray-500 py-2 mt-2 text-xs">Cancelar</button>
        </div>
    </div>

    <script>
        const config = {
            stages: {
                'prospeccao': { title: 'Prospecção', color: 'bg-blue-500' },
                'qualificacao': { title: 'Qualificação', color: 'bg-yellow-500' },
                'proposta': { title: 'Proposta', color: 'bg-orange-500' },
                'negociacao': { title: 'Negociação', color: 'bg-purple-500' },
                'ganho': { title: 'Ganho', color: 'bg-green-600' }
            },
            sbUrl: localStorage.getItem('crm_sb_url') || '',
            sbKey: localStorage.getItem('crm_sb_key') || '',
            cwUrl: localStorage.getItem('crm_cw_url') || '',
            cwToken: localStorage.getItem('crm_cw_token') || '',
            cwAccount: localStorage.getItem('crm_cw_account') || '1'
        };

        const ui = {
            renderBoard: () => {
                const b = document.getElementById('board');
                b.innerHTML = '';
                Object.entries(config.stages).forEach(([k, v]) => {
                    const c = document.createElement('div');
                    c.className = 'flex flex-col w-[300px] min-w-[300px] max-h-full';
                    c.innerHTML = `
                        <div class="flex justify-between mb-3 px-1 items-center">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${v.color}"></span>
                                <h3 class="font-bold text-gray-300 uppercase text-xs tracking-wider">${v.title}</h3>
                            </div>
                            <span class="count bg-card px-2 py-0.5 rounded text-[10px] text-gray-500 border border-border">0</span>
                        </div>
                        <div class="kanban-list flex-1 bg-card/50 rounded-xl p-2 space-y-2 overflow-y-auto border border-border/50 custom-scrollbar" id="col-${k}" data-stage="${k}"></div>
                    `;
                    b.appendChild(c);
                    new Sortable(c.querySelector('.kanban-list'), {
                        group: 'deals', animation: 150, ghostClass: 'ghost-card',
                        onEnd: (evt) => { if (evt.to.dataset.stage !== evt.from.dataset.stage) window.app.moveDeal(evt.item.dataset.id, evt.to.dataset.stage); }
                    });
                });
            },
            createCard: (d) => {
                const el = document.createElement('div');
                el.className = 'deal-card bg-card p-4 rounded-lg border border-border cursor-pointer relative group';
                el.dataset.id = d.id;
                el.onclick = () => window.ui.editDeal(d);
                const val = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(d.value || 0);
                const date = new Date(d.created_at).toLocaleDateString('pt-BR').slice(0, 5);
                
                // NOVO: Etiqueta Insucesso (Cor de Atenção Laranja)
                const insucessoBadge = d.insucesso ? `<div class="text-[10px] bg-orange-500/10 text-orange-400 px-2 py-0.5 rounded inline-block mb-2 border border-orange-500/20 truncate max-w-full mr-1"><i class="fa-solid fa-triangle-exclamation"></i> ${d.insucesso}</div>` : '';
                const productBadge = d.product ? `<div class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded inline-block mb-2 border border-primary/20 truncate max-w-full"><i class="fa-solid fa-car"></i> ${d.product}</div>` : '';
                
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2"><span class="text-[10px] font-bold text-gray-500 uppercase truncate max-w-[150px]">${d.company || 'Cliente'}</span><span class="text-[10px] text-gray-600">${date}</span></div>
                    ${insucessoBadge} ${productBadge}
                    <h4 class="font-bold text-gray-200 text-sm mb-1 truncate">${d.title}</h4>
                    <p class="font-mono text-xs text-gray-400 font-medium">${val}</p>
                `;
                return el;
            },
            openModal: () => {
                document.getElementById('dealForm').reset();
                document.getElementById('dealId').value = '';
                document.getElementById('timelineList').innerHTML = '<div class="text-center text-gray-500 mt-10">Salve para adicionar notas.</div>';
                document.getElementById('dealModal').classList.remove('hidden');
                document.getElementById('btnDelete').classList.add('hidden');
                document.getElementById('btnLoss').classList.add('hidden');
                document.getElementById('btnWin').classList.add('hidden');
                window.app.loadVehicles();
            },
            closeModal: () => document.getElementById('dealModal').classList.add('hidden'),
            editDeal: (d) => {
                document.getElementById('dealId').value = d.id;
                document.getElementById('dealTitle').value = d.title;
                document.getElementById('dealEmail').value = d.email || '';
                document.getElementById('dealPhone').value = d.phone || '';
                document.getElementById('dealValue').value = d.value || 0;
                document.getElementById('dealChatId').value = d.chatwoot_id || '';
                document.getElementById('dealClosing').value = d.closing_date || '';
                document.getElementById('dealInsucesso').value = d.insucesso || ''; // Carrega Insucesso
                
                window.app.loadVehicles().then(() => {
                    const select = document.getElementById('dealProduct');
                    if (d.vehicle_id) select.value = d.vehicle_id;
                    else if (d.product) { for (let i = 0; i < select.options.length; i++) { if (select.options[i].text.includes(d.product)) { select.selectedIndex = i; break; } } }
                });
                
                document.getElementById('modalTitle').innerText = 'Editar Negócio';
                document.getElementById('btnDelete').classList.remove('hidden');
                document.getElementById('btnLoss').classList.remove('hidden');
                document.getElementById('btnWin').classList.remove('hidden');
                document.getElementById('dealModal').classList.remove('hidden');
                window.app.loadTimeline(d.id);
            },
            toggleSettings: () => document.getElementById('settingsModal').classList.toggle('hidden'),
            
            // Relatórios
            openReports: () => {
                document.getElementById('reportsModal').classList.remove('hidden');
                const deals = window.app.deals;
                const stages = config.stages;
                const dataStage = Object.keys(stages).map(k => deals.filter(d => d.stage === k).reduce((acc, curr) => acc + (parseFloat(curr.value)||0), 0));
                
                if(window.chart1) window.chart1.destroy();
                window.chart1 = new Chart(document.getElementById('chartStage'), { type: 'bar', data: { labels: Object.values(stages).map(s => s.title), datasets: [{ label: 'Valor (R$)', data: dataStage, backgroundColor: '#3B82F6', borderRadius: 4 }] }, options: { indexAxis: 'y', maintainAspectRatio: false } });

                // Loss Chart (Mock se não tiver dados)
                const losses = {}; 
                deals.filter(d => d.stage === 'perdido').forEach(d => { const r = d.loss_reason || 'Não informado'; losses[r] = (losses[r]||0)+1; });
                
                if(window.chart2) window.chart2.destroy();
                window.chart2 = new Chart(document.getElementById('chartLoss'), { type: 'doughnut', data: { labels: Object.keys(losses), datasets: [{ data: Object.values(losses), backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6'] }] }, options: { maintainAspectRatio: false } });
            },

            // Motivos
            openReasonsManager: () => {
                document.getElementById('reasonsManagerModal').classList.remove('hidden');
                window.ui.renderReasonsList();
            },
            renderReasonsList: () => {
                const list = document.getElementById('reasonsList');
                list.innerHTML = window.app.reasons.map(r => `
                    <div class="flex justify-between bg-bg p-2 rounded border border-border">
                        <span class="text-white">${r.name}</span>
                        <button onclick="window.app.deleteReason(${r.id})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
            },
            renderReasonSelect: (targetId = 'lossReasonSelect') => {
                const select = document.getElementById(targetId);
                select.innerHTML = '<option value="">Selecione...</option>' + window.app.reasons.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
            },
            cancelLoss: () => { window.app.pendingDrag = null; document.getElementById('selectReasonModal').classList.add('hidden'); window.app.loadDeals(); },
            confirmLoss: () => window.app.confirmLoss(),
            updateCounts: () => document.querySelectorAll('.kanban-list').forEach(l => l.previousElementSibling.querySelector('.count').innerText = l.children.length)
        };

        const app = {
            supabase: null,
            deals: [],
            vehicles: [],
            reasons: [],
            pendingDrag: null,

            init: async () => {
                window.ui.renderBoard();
                if (!config.sbUrl) return window.ui.toggleSettings();
                try {
                    window.app.supabase = window.supabase.createClient(config.sbUrl, config.sbKey);
                    
                    window.app.supabase.channel('public:deals')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'deals' }, () => window.app.loadDeals())
                        .subscribe();

                    await Promise.all([window.app.loadVehicles(), window.app.loadDeals(), window.app.loadReasons()]);
                } catch (e) { console.error(e); }
            },

            loadVehicles: async () => {
                const { data } = await window.app.supabase.from('veiculos_estoque').select('id, modelo_nome, valorvenda').eq('filtro', 'estoque').order('modelo_nome');
                const select = document.getElementById('dealProduct');
                select.innerHTML = '<option value="">Selecione um veículo...</option>';
                if (data) data.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.dataset.price = v.valorvenda;
                    opt.text = `${v.modelo_nome} - R$ ${v.valorvenda}`;
                    select.appendChild(opt);
                });
            },

            loadReasons: async () => {
                const { data } = await window.app.supabase.from('loss_reasons').select('*').order('name');
                window.app.reasons = data || [];
                window.ui.renderReasonSelect(); // Atualiza o select do modal de perda
            },

            saveReason: async (e) => {
                e.preventDefault();
                await window.app.supabase.from('loss_reasons').insert([{ name: document.getElementById('newReasonName').value }]);
                document.getElementById('newReasonName').value = '';
                await window.app.loadReasons();
                window.ui.renderReasonsList();
            },

            deleteReason: async (id) => {
                if(confirm('Excluir?')) {
                    await window.app.supabase.from('loss_reasons').delete().eq('id', id);
                    await window.app.loadReasons();
                    window.ui.renderReasonsList();
                }
            },

            autoFillPrice: () => {
                const select = document.getElementById('dealProduct');
                const price = select.options[select.selectedIndex]?.getAttribute('data-price');
                if (price) document.getElementById('dealValue').value = price;
            },

            loadDeals: async () => {
                const { data } = await window.app.supabase.from('deals').select('*').neq('stage', 'perdido').order('created_at', { ascending: false });
                window.app.deals = data || []; // Guarda para relatórios
                document.querySelectorAll('.kanban-list').forEach(el => el.innerHTML = '');
                let total = 0;
                window.app.deals.forEach(d => {
                    if (config.stages[d.stage]) {
                        document.getElementById(`col-${d.stage}`).appendChild(window.ui.createCard(d));
                        total += d.value || 0;
                    }
                });
                document.getElementById('total-pipeline').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
                window.ui.updateCounts();
            },

            saveDeal: async (e, stageOverride = null) => {
                if (e) e.preventDefault();
                const id = document.getElementById('dealId').value;
                const selectProduct = document.getElementById('dealProduct');
                
                const deal = {
                    title: document.getElementById('dealTitle').value,
                    email: document.getElementById('dealEmail').value,
                    phone: document.getElementById('dealPhone').value,
                    value: document.getElementById('dealValue').value || 0,
                    chatwoot_id: document.getElementById('dealChatId').value || null,
                    closing_date: document.getElementById('dealClosing').value || null,
                    vehicle_id: selectProduct.value || null,
                    product: selectProduct.selectedIndex > 0 ? selectProduct.options[selectProduct.selectedIndex].text : null,
                    insucesso: document.getElementById('dealInsucesso').value || null // NOVO: Salva Insucesso
                };

                if (stageOverride) {
                    deal.stage = stageOverride;
                    if (stageOverride === 'ganho' && !deal.closing_date) deal.closing_date = new Date().toISOString().split('T')[0];
                }

                if (!id) {
                    deal.stage = deal.stage || 'prospeccao';
                    await window.app.supabase.from('deals').insert([deal]);
                } else {
                    await window.app.supabase.from('deals').update(deal).eq('id', id);
                }
                
                window.ui.closeModal();
                window.app.loadDeals();
                if (stageOverride === 'ganho') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            },

            moveDeal: async (id, newStage) => {
                if (newStage === 'perdido') {
                    window.app.pendingDrag = id;
                    document.getElementById('selectReasonModal').classList.remove('hidden');
                } else {
                    const updateData = { stage: newStage };
                    if (newStage === 'ganho') updateData.closing_date = new Date().toISOString().split('T')[0];
                    await window.app.supabase.from('deals').update(updateData).eq('id', id);
                    if (newStage === 'ganho') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    window.app.loadDeals();
                }
            },

            confirmLoss: async () => {
                const reason = document.getElementById('lossReasonSelect').value;
                if (!reason) return alert("Selecione um motivo!");
                const id = window.app.pendingDrag || document.getElementById('dealId').value;
                await window.app.supabase.from('deals').update({ stage: 'perdido', loss_reason: reason }).eq('id', id);
                window.app.pendingDrag = null;
                document.getElementById('selectReasonModal').classList.add('hidden');
                window.ui.closeModal();
                window.app.loadDeals();
            },

            requestLoss: () => { document.getElementById('selectReasonModal').classList.remove('hidden'); },
            
            deleteDeal: async () => {
                if (confirm('Excluir permanentemente?')) {
                    await window.app.supabase.from('deals').delete().eq('id', document.getElementById('dealId').value);
                    window.ui.closeModal();
                    window.app.loadDeals();
                }
            },

            exportCSV: () => {
                const deals = window.app.deals;
                if(!deals.length) return alert('Nada para exportar.');
                const headers = ['ID', 'Cliente', 'Etapa', 'Valor', 'Data Criação', 'Veículo', 'Insucesso', 'Motivo Perda'];
                const rows = deals.map(d => [
                    d.id, d.title, d.stage, d.value, new Date(d.created_at).toLocaleDateString(), d.product || '', d.insucesso || '', d.loss_reason || ''
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(e => e.join(','))].join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "deals_export.csv");
                document.body.appendChild(link);
                link.click();
            },

            loadTimeline: async (dealId) => {
                const list = document.getElementById('timelineList');
                list.innerHTML = '<div class="text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i></div>';
                const { data } = await window.app.supabase.from('timeline').select('*').eq('deal_id', dealId).order('created_at', { ascending: false });
                if (!data || data.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 mt-10">Nenhum histórico.</div>'; return; }
                list.innerHTML = data.map(t => {
                    const date = new Date(t.created_at).toLocaleString('pt-BR');
                    return `<div class="flex gap-3 text-xs"><div class="mt-1 w-6 h-6 rounded flex-shrink-0 flex items-center justify-center bg-blue-500/10 text-blue-400"><i class="fa-solid fa-comment"></i></div><div class="flex-1 bg-card border border-border p-2 rounded"><p class="text-gray-300">${t.description}</p><span class="text-[10px] text-gray-600 block mt-1 text-right">${date}</span></div></div>`;
                }).join('');
            },

            addNote: async (e) => {
                e.preventDefault();
                const input = document.getElementById('newNoteInput');
                const text = input.value.trim();
                const dealId = document.getElementById('dealId').value;
                if (!text || !dealId) return;
                await window.app.supabase.from('timeline').insert([{ deal_id: dealId, action_type: 'nota', description: text }]);
                input.value = '';
                window.app.loadTimeline(dealId);
            },

            saveSettings: () => {
                localStorage.setItem('crm_sb_url', document.getElementById('sbUrl').value);
                localStorage.setItem('crm_sb_key', document.getElementById('sbKey').value);
                localStorage.setItem('crm_cw_url', document.getElementById('cwUrl').value);
                localStorage.setItem('crm_cw_token', document.getElementById('cwToken').value);
                localStorage.setItem('crm_cw_account', document.getElementById('cwAccount').value);
                location.reload();
            },

            fetchChatwootData: async () => { alert("Configurar integração Chatwoot nas opções."); }
        };

        window.ui = ui;
        window.app = app;
        document.addEventListener('DOMContentLoaded', window.app.init);
    </script>
</body>
</html>
